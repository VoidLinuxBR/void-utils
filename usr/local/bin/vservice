#!/usr/bin/env bash
# -*- coding: utf-8 -*-
# shellcheck shell=bash disable=SC1091,SC2039,SC2166,SC2034
#
#  vservice
#  Wrapper para o sv
#  Created: 18.09.2022 15:10:00 -04
#  Altered: sex 06 fev 2026 04:24:23 -04
#  Updated: sex 06 fev 2026 04:24:23 -04
#
#  Copyright (c) 2026-2026, Vilmar Catafesta <vcatafesta@gmail.com>
#  Assembled By Vilmar Catafesta for the ChiliLinux project.
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions
#  are met:
#  1. Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
#  2. Redistributions in binary form must reproduce the above copyright
#     notice, this list of conditions and the following disclaimer in the
#     documentation and/or other materials provided with the distribution.
#
#  THIS SOFTWARE IS PROVIDED BY Vilmar Catafesta ''AS IS'' AND ANY EXPRESS OR
#  IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
#  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
#  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
#  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
#  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
#  THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
#  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
#  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
##############################################################################
#export LANGUAGE=pt_BR
export TEXTDOMAINDIR=/usr/share/locale
export TEXTDOMAIN=vservice

SV_DIR="/etc/sv"
ACTIVE_DIR="/var/service"

# ─────────────────────────────
# Cores
# ─────────────────────────────
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
RESET='\033[0m'

msg()  { echo -e "${GREEN}✔${RESET} $*"; }
warn() { echo -e "${YELLOW}⚠${RESET} $*"; }
err()  { echo -e "${RED}✘${RESET} $*" >&2; }
info() { echo -e "${BLUE}➜${RESET} $*"; }

# ─────────────────────────────
# Root check
# ─────────────────────────────
sh_checkroot() {
  ((EUID == 0)) && return 0

  if command -v sudo >/dev/null 2>&1; then
    exec sudo bash "$0" "$@"
  elif command -v su >/dev/null 2>&1; then
    exec su -c "$0 $*"
  else
    err "precisa ser root (sem sudo/su disponível)"
    exit 1
  fi
}

usage() {
  echo -e "${BLUE}vservice${RESET} — gerenciador simples de serviços (${YELLOW}runit${RESET})"
  echo
  echo -e "${GREEN}Uso:${RESET}"
  echo -e "  ${BLUE}vservice${RESET} ${YELLOW}{enable|disable|remove|start|stop|restart|status|list}${RESET} ${GREEN}[service]${RESET}"
  echo
  echo -e "${GREEN}Comandos:${RESET}"
  echo -e "  ${YELLOW}enable${RESET}   — habilita o serviço (cria link em ${BLUE}/var/service${RESET})"
  echo -e "  ${YELLOW}disable${RESET}  — para o serviço sem remover"
  echo -e "  ${YELLOW}remove${RESET}   — para e remove o serviço"
  echo -e "  ${YELLOW}start${RESET}    — inicia um serviço já habilitado"
  echo -e "  ${YELLOW}stop${RESET}     — para o serviço"
  echo -e "  ${YELLOW}restart${RESET}  — reinicia o serviço"
  echo -e "  ${YELLOW}status${RESET}   — mostra o status do serviço"
  echo -e "  ${YELLOW}list${RESET}     — lista todos os serviços ativos"
  echo
  exit 1
}

# ─────────────────────────────
# Argumentos
# ─────────────────────────────
[[ $# -eq 1 && $1 == list ]] || [[ $# -eq 2 ]] || usage

sh_checkroot "$@"

ACTION="$1"
SERVICE="$2"

SV_PATH="$SV_DIR/$SERVICE"
ACTIVE_PATH="$ACTIVE_DIR/$SERVICE"

check_service_exists() {
  [[ -d "$SV_PATH" ]] || {
    err "serviço '$SERVICE' não existe em $SV_DIR"
    exit 1
  }
}

show_status() {
  if command -v vsv >/dev/null; then
    vsv | grep -i "$SERVICE"
  else
    sv status "$SERVICE"
  fi
}

# ─────────────────────────────
# Ações
# ─────────────────────────────
case "$ACTION" in
enable)
  check_service_exists

  if [[ -L "$ACTIVE_PATH" ]]; then
    warn "serviço '$SERVICE' já está habilitado"
  else
    ln -s "$SV_PATH" "$ACTIVE_PATH"
    msg "serviço '$SERVICE' habilitado"
  fi

  sleep 3
  show_status
;;

disable)
  if [[ -L "$ACTIVE_PATH" ]]; then
    sv stop "$SERVICE"
    msg "serviço '$SERVICE' parado"
  else
    warn "serviço '$SERVICE' não está habilitado"
  fi
;;

remove)
  if [[ -L "$ACTIVE_PATH" ]]; then
    sv stop "$SERVICE"
    rm -f "$ACTIVE_PATH"
    msg "serviço '$SERVICE' removido"
  else
    warn "serviço '$SERVICE' não está habilitado"
  fi
;;

start)
  check_service_exists

  if [[ ! -L "$ACTIVE_PATH" ]]; then
    err "serviço '$SERVICE' existe mas NÃO está habilitado"
    err "use: vservice enable $SERVICE"
    exit 1
  fi

  info "sv start $SERVICE"
  sv start "$SERVICE"

  sleep 3
# sv status "$SERVICE"
  show_status
;;

stop|restart|status)
  check_service_exists
  info "sv $ACTION $SERVICE"
#  sv "$ACTION" "$SERVICE"
  show_status
;;

list)
  command -v vsv >/dev/null && vsv || sv status /var/service/*
;;

*)
  usage
;;
esac

